<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SÃ¼rÃ¼cÃ¼ Kontrol Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 1; width: 100%; }
        .admin-panel { background: #222; padding: 15px; border-top: 2px solid #444; max-height: 40vh; overflow-y: auto; }
        .request-card { background: #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #f1c40f; }
        .request-card h4 { margin: 0 0 5px 0; color: #f1c40f; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .admin-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-accept { background: #27ae60; }
        .btn-call { background: #2980b9; }
        .btn-complete { background: #c0392b; }
        .status-control { display: flex; justify-content: space-around; padding: 10px; background: #000; }
    </style>
</head>
<body>

<div class="status-control" style="background: #000; padding: 10px; text-align: center;">
    <button id="status-toggle-btn" onclick="durumDegistir()" style="
        width: 80%; 
        max-width: 400px; 
        padding: 15px; 
        font-size: 20px; 
        font-weight: bold; 
        border: none; 
        border-radius: 10px; 
        cursor: pointer; 
        transition: 0.3s;
        background: #27ae60; 
        color: white;
    ">ğŸŸ¢ ÅU AN: MÃœSAÄ°T</button>
</div>

<div id="map"></div>

<div class="admin-panel" id="request-list">
    <h3 style="text-align:center;">ğŸ“¥ Gelen Talepler</h3>
    <div id="requests-container">
        <p style="text-align:center; color:#888;">HenÃ¼z yeni bir talep yok...</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCrQOAPqhC_vnCly0twAJB0jrOS-Z9G3yA",
        databaseURL: "https://moto-tax-b2e0a-default-rtdb.firebaseio.com",
        projectId: "moto-tax-b2e0a",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- KÃœRESEL DEÄÄ°ÅKENLER (HatanÄ±n Ã§Ã¶zÃ¼mÃ¼ burada) ---
    let activeMarkers = [];
    let routingControl = null;

    // Harita Kurulumu
    const map = L.map('map').setView([41.015, 28.979], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 1. TALEPLERÄ° DÄ°NLE
    database.ref('talepler').on('value', (snapshot) => {
        const container = document.getElementById('requests-container');
        container.innerHTML = "";
        const data = snapshot.val();
        if (!data) {
            container.innerHTML = '<p style="text-align:center; color:#888;">HenÃ¼z yeni bir talep yok...</p>';
            return;
        }
        Object.keys(data).forEach(key => {
            const talep = data[key];
            if (talep.durum === "bekliyor") {
                const card = `
                    <div class="request-card">
                        <h4>ğŸ‘¤ ${talep.musteriAd}</h4>
                        <p>ğŸ“ ${talep.musteriTel}</p>
                        <p><small>ğŸ“ ${talep.baslangic.adres}</small></p>
                        <p><small>ğŸ ${talep.varis.adres}</small></p>
                        <div class="btn-group">
                            <button class="admin-btn btn-accept" onclick="haritadaGoster(${talep.baslangic.lat}, ${talep.baslangic.lng}, ${talep.varis.lat}, ${talep.varis.lng})">ğŸ—ºï¸ RotayÄ± GÃ¶r</button>
                            <button class="admin-btn btn-call" onclick="window.location.href='tel:${talep.musteriTel}'">ğŸ“ Ara</button>
                            <button class="admin-btn btn-complete" onclick="talepSil('${key}')">âœ… Tamamla</button>
                        </div>
                    </div>`;
                container.innerHTML += card;
            }
        });
    });

    // 2. HARÄ°TADA ROTA GÃ–STER
    window.haritadaGoster = function(slat, slng, elat, elng) {
        // Eski markerlarÄ± ve rotayÄ± temizle
        activeMarkers.forEach(m => map.removeLayer(m));
        activeMarkers = [];
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }

        const startPoint = L.latLng(slat, slng);
        const endPoint = L.latLng(elat, elng);

        routingControl = L.Routing.control({
            waypoints: [startPoint, endPoint],
            lineOptions: { styles: [{ color: '#007bff', weight: 6, opacity: 0.8 }] },
            createMarker: function(i, wp) {
                const marker = L.marker(wp.latLng, {
                    draggable: false,
                    icon: L.icon({
                        iconUrl: i === 0 ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png' : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                });
                activeMarkers.push(marker);
                return marker;
            },
            addWaypoints: false,
            show: false
        }).addTo(map);

        routingControl.on('routesfound', function() {
            map.fitBounds(L.latLngBounds([startPoint, endPoint]), {padding: [50, 50]});
        });
    };

    // 3. TALEBÄ° SÄ°L / TAMAMLA
    window.talepSil = function(id) {
        if(confirm("Bu iÅŸlemi tamamladÄ±nÄ±z mÄ±? KayÄ±t silinecektir.")) {
            database.ref('talepler/' + id).remove().then(() => {
                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                activeMarkers.forEach(m => map.removeLayer(m));
                activeMarkers = [];
            });
        }
    };

    // 4. DURUM GÃœNCELLEME
    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda mevcut durumu veritabanÄ±ndan Ã§ekip butonu ayarla
    database.ref('durum').on('value', (snapshot) => {
        const mevcutDurum = snapshot.val() || "MÃ¼sait";
        const btn = document.getElementById('status-toggle-btn');
        
        if (mevcutDurum === "MÃ¼sait") {
            btn.style.background = "#27ae60"; // YeÅŸil
            btn.innerText = "ğŸŸ¢ ÅU AN: MÃœSAÄ°T";
        } else {
            btn.style.background = "#c0392b"; // KÄ±rmÄ±zÄ±
            btn.innerText = "ğŸ”´ ÅU AN: MEÅGUL";
        }
    });

    // Butona tÄ±klandÄ±ÄŸÄ±nda durumu tersine Ã§evirir
    window.durumDegistir = function() {
        const btn = document.getElementById('status-toggle-btn');
        const suAnkiMetin = btn.innerText;

        if (suAnkiMetin.includes("MÃœSAÄ°T")) {
            database.ref('durum').set("MeÅŸgul");
        } else {
            database.ref('durum').set("MÃ¼sait");
        }
        // Alert (uyarÄ±) kaldÄ±rÄ±ldÄ±, sadece renk ve yazÄ± deÄŸiÅŸecek
    };
    

    // 5. KONUM PAYLAÅ
    function konumPaylas() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                database.ref('konum').push({
                    location: { coords: { latitude: position.coords.latitude, longitude: position.coords.longitude } },
                    timestamp: Date.now()
                });
            }, (err) => console.error(err), { enableHighAccuracy: true });
        }
    }
    konumPaylas();
</script>
</body>
</html>