<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Moto-Taksi CanlÄ± Takip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #111; color: #fff; }
        header { padding: 15px; text-align: center; background: #000; border-bottom: 2px solid #333; }
        #status { font-size: 20px; font-weight: bold; padding: 10px; border-radius: 8px; margin-top: 10px; display: inline-block; }
        #map { height: 70vh; width: 100%; }
        .panel { padding: 20px; text-align: center; }
        .btn { display: block; margin: 10px auto; padding: 15px; width: 90%; max-width: 300px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold; }
        .call { background: #1db954; color: black; }
        .free { background: #00cc66; color: white; }
        .busy { background: #ff4444; color: white; }
    
        /* ROTA BÄ°LGÄ° PANELÄ° STÄ°LLERÄ° */
        .route-panel {
        background: rgba(255, 255, 255, 0.1); /* Saydam beyaz doku */
        backdrop-filter: blur(10px); /* Arka planÄ± bulanÄ±klaÅŸtÄ±rÄ±r, Ã§ok ÅŸÄ±k durur */
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px;
        margin: 10px;
        border-radius: 12px;
        }
        .location-box {
            background: #1a1a1a; /* Body'den farklÄ±, koyu gri panel */
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #fff; /* Yan tarafÄ±na renkli Ã§izgi */
        }
        .start-box { border-left-color: #00cc66; } /* BaÅŸlangÄ±Ã§ yeÅŸil */
        .end-box { border-left-color: #ff4444; }   /* VarÄ±ÅŸ kÄ±rmÄ±zÄ± */
        
        .mini-delete-btn {
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        .mini-delete-btn:hover { background: #666; }
    </style>
</head>
<body>

<header>
    <h2>Motorcu Nerede?</h2>
    <div id="status">YÃ¼kleniyor...</div>
</header>

<div id="map"></div>


<div class="route-panel">
    <div class="location-box start-box">
        <span id="start-point">ğŸ“ BaÅŸlangÄ±Ã§: Bekleniyor...</span>
        <button class="mini-delete-btn" onclick="tekilSil('start')">Sil</button>
    </div>
    <div class="location-box end-box">
        <span id="end-point">ğŸ VarÄ±ÅŸ: Bekleniyor...</span>
        <button class="mini-delete-btn" onclick="tekilSil('end')">Sil</button>
    </div>
</div>
<!-- <div class="panel" style="background: #222; margin-bottom: 10px;">
    <div id="route-info">
        <p id="start-point">ğŸ“ BaÅŸlangÄ±Ã§: SeÃ§ilmedi</p>
        <p id="end-point">ğŸ VarÄ±ÅŸ: SeÃ§ilmedi</p>
    </div>
    <button class="btn" onclick="rotayiSifirla()" style="background: #555; font-size: 14px; width: auto; padding: 5px 15px;">SeÃ§imleri Temizle</button>
</div> -->

<div class="panel">
    <a href="tel:+905XXXXXXXXX" class="btn call">ğŸ“ Hemen Ara / Ã‡aÄŸÄ±r</a>
    <p><small>Konumum her 10 saniyede bir gÃ¼ncellenir.</small></p>
</div>
  <!-- // Firebase ve Leaflet JS dosyalarÄ± -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!--  haritaya konum ekleme dosyasÄ± yani arama yapabilecek -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>



<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCrQOAPqhC_vnCly0twAJB0jrOS-Z9G3yA",
        databaseURL: "https://moto-tax-b2e0a-default-rtdb.firebaseio.com",
        projectId: "moto-tax-b2e0a",
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // HARÄ°TA KURULUMU
    const map = L.map('map').setView([41.015, 28.979], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const taxiIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/31/31135.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
    });

    var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
    })
        .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
            
            // Aramadan gelen sonucu baÅŸlangÄ±Ã§ veya varÄ±ÅŸ noktasÄ± olarak ayarla
            if (!startMarker) {
                startMarker = L.marker(e.geocode.center).addTo(map).bindPopup("BaÅŸlangÄ±Ã§: " + e.geocode.name).openPopup();
                document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: " + e.geocode.name;
            } else {
                endMarker = L.marker(e.geocode.center).addTo(map).bindPopup("VarÄ±ÅŸ: " + e.geocode.name).openPopup();
                document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: " + e.geocode.name;
            }
        })
        .addTo(map);

    const marker = L.marker([41.015, 28.979], {icon: taxiIcon}).addTo(map);

    // 1. DURUMU TAKÄ°P ET (MÃ¼ÅŸteri iÃ§in en Ã¶nemli kÄ±sÄ±m)
    database.ref('durum').on('value', (snapshot) => {
        const s = snapshot.val() || "MÃ¼sait";
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = (s === 'MÃ¼sait' ? 'ğŸŸ¢ ' : 'ğŸ”´ ') + s;
        statusDiv.className = (s === 'MÃ¼sait' ? 'free' : 'busy');
    });

    // 2. KONUMU TAKÄ°P ET
    database.ref('konum').on('value', (snapshot) => {
        const rawData = snapshot.val();
        if (rawData) {
            const keys = Object.keys(rawData);
            const latestKey = keys[keys.length - 1];
            const data = rawData[latestKey];

            if (data && data.location && data.location.coords) {
                const lat = data.location.coords.latitude;
                const lng = data.location.coords.longitude;
                marker.setLatLng([lat, lng]);
                map.panTo([lat, lng]);
            }
        }
    });


    let startMarker = null;
    let endMarker = null;

    map.on('click', function(e) {
        if (!startMarker) {
            // Ä°lk tÄ±klama: BaÅŸlangÄ±Ã§
            startMarker = L.marker(e.latlng, {draggable: true}).addTo(map)
                .bindPopup("Seni buradan alacaÄŸÄ±m").openPopup();
            document.getElementById('start-point').innerHTML = `ğŸ“ BaÅŸlangÄ±Ã§: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        } else if (!endMarker) {
            // Ä°kinci tÄ±klama: VarÄ±ÅŸ
            endMarker = L.marker(e.latlng, {draggable: true, icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30, 30]})}).addTo(map)
                .bindPopup("Buraya gideceÄŸiz").openPopup();
            document.getElementById('end-point').innerHTML = `ğŸ VarÄ±ÅŸ: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            
            // Firebase'e bu talebi gÃ¶nderebiliriz
            talebiGonder(startMarker.getLatLng(), endMarker.getLatLng());
        }
    });

   // rota noktalarÄ±nÄ± silme fonktsiyorun//
    function tekilSil(tip) {
        if (tip === 'start') {
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: Bekleniyor...";
        } else if (tip === 'end') {
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: Bekleniyor...";
        }
    }

    // --- GÃœNCELLENMÄ°Å GEOCODER (Arama Kutusu MantÄ±ÄŸÄ±) ---
    var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
    })
    .on('markgeocode', function(e) {
        // EÄŸer baÅŸlangÄ±Ã§ boÅŸsa oraya, deÄŸilse varÄ±ÅŸa ata
        if (!startMarker) {
            startMarker = L.marker(e.geocode.center).addTo(map).bindPopup("BaÅŸlangÄ±Ã§").openPopup();
            document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: " + e.geocode.name;
        } else if (!endMarker) {
            endMarker = L.marker(e.geocode.center).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
            document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: " + e.geocode.name;
        }
        map.panTo(e.geocode.center);
    })
    .addTo(map);
    // function rotayiSifirla() {
    //     if (startMarker) map.removeLayer(startMarker);
    //     if (endMarker) map.removeLayer(endMarker);
    //     startMarker = null;
    //     endMarker = null;
    //     document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: SeÃ§ilmedi";
    //     document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: SeÃ§ilmedi";
    // }
</script>
</body>
</html>