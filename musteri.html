<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Moto-Taksi CanlÄ± Takip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #111; color: #fff; }
        header { padding: 15px; text-align: center; background: #000; border-bottom: 2px solid #333; }
        #status { font-size: 20px; font-weight: bold; padding: 10px; border-radius: 8px; margin-top: 10px; display: inline-block; }
        #map { height: 60vh; width: 100%; }
        .panel { padding: 15px; text-align: center; }
        .btn { display: block; margin: 10px auto; padding: 15px; width: 90%; max-width: 300px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; font-weight: bold; }
        .call { background: #1db954; color: black; }
        .free { background: #00cc66; color: white; }
        .busy { background: #ff4444; color: white; }
        
        .route-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 15px; margin: 10px; border-radius: 12px; }
        .location-box { background: #1a1a1a; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #fff; }
        .start-box { border-left-color: #00cc66; }
        .end-box { border-left-color: #ff4444; }
        .mini-delete-btn { background: #444; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <h2>Motorcu Nerede?</h2>
    <div id="status">YÃ¼kleniyor...</div>
</header>

<div class="route-panel" style="background: rgba(0,0,0,0.3);">
    <input type="text" id="customer-name" placeholder="isim soyisim istemiyorsan - yaz" style="width: 90%; padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #444; background: #222; color: white;">
    <input type="tel" id="customer-phone" placeholder="Tel No, istemiyorsan - yaz (05xx)" style="width: 90%; padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #444; background: #222; color: white;">
</div>

<div id="map"></div>

<div class="route-panel">
    <div class="location-box start-box">
        <span id="start-point">ğŸ“ BaÅŸlangÄ±Ã§: Bekleniyor...</span>
        <button class="mini-delete-btn" onclick="tekilSil('start')">Sil</button>
    </div>
    <div class="location-box end-box">
        <span id="end-point">ğŸ VarÄ±ÅŸ: Bekleniyor...</span>
        <button class="mini-delete-btn" onclick="tekilSil('end')">Sil</button>
    </div>
</div>

<div class="panel">
    <button id="locate-btn" class="btn" style="background: #3498db;">ğŸ“ Mevcut Konumumu Kullan</button>
    <button id="send-request-btn" class="btn" style="background: #f1c40f; color: black;" onclick="talebiDatabaseGonder()">ğŸš€ Talebi SÃ¼rÃ¼cÃ¼ye GÃ¶nder</button>
    <a href="tel:+905438206561" class="btn call">ğŸ“ Hemen Ara / Ã‡aÄŸÄ±r</a>
</div>

<button id="focus-taxi-btn" style="
    position: absolute; 
    bottom: 20px; 
    left: 10px; 
    z-index: 1000; 
    background: #fff; 
    border: 2px solid #333; 
    border-radius: 50%; 
    width: 50px; 
    height: 50px; 
    cursor: pointer; 
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
">ğŸš•</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCrQOAPqhC_vnCly0twAJB0jrOS-Z9G3yA",
        databaseURL: "https://moto-tax-b2e0a-default-rtdb.firebaseio.com",
        projectId: "moto-tax-b2e0a",
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DeÄŸiÅŸkenler
    let startMarker = null;
    let endMarker = null;

    // Harita
    const map = L.map('map').setView([41.015, 28.979], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const taxiIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/31/31135.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
    });
    const marker = L.marker([41.015, 28.979], {icon: taxiIcon}).addTo(map);

    // Arama Kutusu
    var geocoder = L.Control.geocoder({ defaultMarkGeocode: false })
    .on('markgeocode', function(e) {
        if (!startMarker) {
            startMarker = L.marker(e.geocode.center).addTo(map).bindPopup("BaÅŸlangÄ±Ã§").openPopup();
            document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: " + e.geocode.name;
        } else if (!endMarker) {
            endMarker = L.marker(e.geocode.center).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
            document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: " + e.geocode.name;
        }
        map.panTo(e.geocode.center);
    }).addTo(map);

    // TÄ±klama ile SeÃ§im
    map.on('click', function(e) {
        if (!startMarker) {
            startMarker = L.marker(e.latlng).addTo(map).bindPopup("BaÅŸlangÄ±Ã§").openPopup();
            document.getElementById('start-point').innerHTML = ` BaÅŸlangÄ±Ã§: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        } else if (!endMarker) {
            endMarker = L.marker(e.latlng).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
            document.getElementById('end-point').innerHTML = `ğŸ VarÄ±ÅŸ: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        }
    });

    // Silme Fonksiyonu
    window.tekilSil = function(tip) {
        if (tip === 'start' && startMarker) {
            map.removeLayer(startMarker);
            startMarker = null;
            document.getElementById('start-point').innerHTML = "ğŸ“ BaÅŸlangÄ±Ã§: Bekleniyor...";
        } else if (tip === 'end' && endMarker) {
            map.removeLayer(endMarker);
            endMarker = null;
            document.getElementById('end-point').innerHTML = "ğŸ VarÄ±ÅŸ: Bekleniyor...";
        }
    };

    // Konumumu Kullan Butonu
    document.getElementById('locate-btn').addEventListener('click', function() {
        map.locate({setView: true, maxZoom: 16});
    });

    map.on('locationfound', function(e) {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(e.latlng).addTo(map).bindPopup("BuradasÄ±nÄ±z").openPopup();
        document.getElementById('start-point').innerHTML = " BaÅŸlangÄ±Ã§: Mevcut Konum";
    });

    // VERÄ° GÃ–NDERME FONKSÄ°YONU (DÄ±ÅŸarÄ±da olmalÄ±!)

    window.talebiDatabaseGonder = function() {
    const name = document.getElementById('customer-name').value;
    const phone = document.getElementById('customer-phone').value;

    if (!name || !phone) {
        alert("LÃ¼tfen isim ve telefon numaranÄ±zÄ± girin.");
        return;
    }

    if (startMarker && endMarker) {
        const yeniTalepRef = database.ref('talepler').push();
        yeniTalepRef.set({
            musteriAd: name,
            musteriTel: phone,
            baslangic: { 
                lat: startMarker.getLatLng().lat, 
                lng: startMarker.getLatLng().lng, 
                adres: document.getElementById('start-point').innerText 
            },
            varis: { 
                lat: endMarker.getLatLng().lat, 
                lng: endMarker.getLatLng().lng, 
                adres: document.getElementById('end-point').innerText 
            },
            zaman: Date.now(),
            durum: "bekliyor"
        }).then(() => {
            alert("Talebiniz baÅŸarÄ±yla iletildi, kurye sizi arayabilir.");
        });
    } else {
        alert("LÃ¼tfen haritadan rotanÄ±zÄ± seÃ§in.");
    }
    };  

    // SÃ¼rÃ¼cÃ¼ Durumu ve Konumu (Zaten Ã§alÄ±ÅŸÄ±yordu)
    database.ref('durum').on('value', (s) => {
        const d = s.val() || "MÃ¼sait";
        const div = document.getElementById('status');
        div.innerHTML = (d === 'MÃ¼sait' ? 'ğŸŸ¢ ' : 'ğŸ”´ ') + d;
        div.className = (d === 'MÃ¼sait' ? 'free' : 'busy');
    });

    let ilkOdaklanmaYapildi = false ; // HaritanÄ±n her saniye zÄ±playÄ±p kullanÄ±cÄ±yÄ± rahatsÄ±z etmemesi iÃ§in

    database.ref('konum').on('value', (s) => {
    const raw = s.val();
        if (raw) {
            const keys = Object.keys(raw);
            const data = raw[keys[keys.length - 1]];
            if (data?.location?.coords) {
                const { latitude: lat, longitude: lng } = data.location.coords;
                
                // 1. Taksi simgesini senin olduÄŸun yere taÅŸÄ±r
                marker.setLatLng([lat, lng]);

                // 2. Harita kamerasÄ±nÄ± senin olduÄŸun yere kaydÄ±rÄ±r
                if (!ilkOdaklanmaYapildi) {
                    // Sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda doÄŸrudan oraya git ve yakÄ±nlaÅŸ
                    map.setView([lat, lng], 15);
                    ilkOdaklanmaYapildi = false;
                } 
                // else {
                //     // Sonraki gÃ¼ncellemelerde haritayÄ± yumuÅŸak bir ÅŸekilde oraya kaydÄ±r
                //     map.panTo([lat, lng]);
                // }
            }
        }
    });

    document.getElementById('focus-taxi-btn').addEventListener('click', function() {
        if (marker) {
            const taxiPos = marker.getLatLng();
            // flyTo komutu haritayÄ± kaydÄ±rmak yerine "uÃ§arak" hedefe gider, daha ÅŸÄ±ktÄ±r.
            map.flyTo(taxiPos, 16, {
                animate: true,
                duration: 1.5
            });
        } else {
            alert("Kurye konumu henÃ¼z alÄ±namadÄ±.");
        }
    });
</script>
</body>
</html>